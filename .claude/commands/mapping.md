---
description: Map people to facility locations and build Account Targeting List (ATL)
allowed-tools: Read, Write, Bash, Glob, Grep
---

# People-to-Location Mapping & ATL Builder

Build an Account Targeting List (ATL) by matching a raw people list against facility location data, then capping leads per location.

## Pipeline Overview

```
People List.csv (raw)          account locations/*.csv
       │                              │
       └──────────┬───────────────────┘
                  ▼
     STEP 1: Match people → locations
                  │
                  ▼
     STEP 2: Filter to matched leads only
                  │
                  ▼
     STEP 3: Cap at 5/location with seniority priority
                  │
                  ▼
        ATL CSV (final output)
```

## Prerequisites

Before running this skill, you need:
1. **A People List CSV** with these columns: `Account Name`, `Account ID`, `First Name`, `Last Name`, `Full Name.`, `Job Title`, `Persona`, `Company Domain`, `Domain`, `LinkedIn Profile`, `Enrich person`, `Final Location`
2. **Location CSVs** in `account locations/` subdirectory (one per account, generated by `/locations` skill) with columns: `company`, `location_name`, `facility_type`, `street_address`, `city`, `state_province`, `postal_code`, `country`, `phone`, `products_manufactured`, `notes`, `source_url`, `extracted_date`

Both should be in the same parent directory (e.g., `~/locations and contacts/`).

**ASK THE USER** for the path to the People List CSV if not obvious from context.

---

## STEP 1: Match People to Locations

For each person, extract their city/state from the `Final Location` field (format: `"City, State, Country"`) and match against facility locations for their account.

### Matching Logic

Match a person to a facility when the person's city/state matches the facility's city/state. Use this priority:

1. **exact_match** — City AND state both match exactly (case-insensitive, after normalization)
2. **fuzzy_match** — City is a close match (e.g., abbreviation, partial match) AND state matches
3. **state_only_match** — Only state matches (use only when there's a single facility in that state)
4. **multiple_matches** — Person's city/state matches multiple facilities; include ALL matches with values semicolon-separated
5. **no_city_match** — No facility found in the person's city/state
6. **location_too_vague** — Person's `Final Location` is missing or can't be parsed

### State Normalization

Normalize state names and abbreviations (e.g., `Texas` ↔ `TX`, `MD` ↔ `Maryland`).

### Output Columns

Append these columns to each row:
- `matched_location_name`, `matched_facility_type`, `matched_street_address`, `matched_city`, `matched_state_province`, `matched_postal_code`, `matched_country`, `matched_phone`, `matched_products_manufactured`, `matched_notes`, `matched_source_url`, `matched_extracted_date`, `match_status`

For `multiple_matches`, join all matched values with `; ` (semicolon-space).

### Write Enriched File

Save as: `People List - Enriched.csv` (same directory as input, same row count as input).

Print summary: total rows, match status counts, match rate.

---

## STEP 2: Filter to Matched Leads Only

Remove rows where `match_status` is `no_city_match` or `location_too_vague`.

Save as: `People List - Matched Leads (New).csv`

Print summary: rows before/after, unique locations, unique accounts.

---

## STEP 3: Cap at 5 Leads Per Location (ATL)

Create the final Account Targeting List, capped at **5 people max per location**.

### Location Key

A unique location = composite of: `matched_location_name` + `matched_street_address` + `matched_city` + `matched_state_province`

(Rows with `multiple_matches` have semicoloned values — treat the composite string as its own location key.)

### Selection Logic

**Locations with ≤5 leads** → keep ALL rows as-is (no filtering)

**Locations with >5 leads** → pick best 5 using seniority priority:

**Tier 1 — Director+ with target persona:**
Matches BOTH a target persona AND a Director+ title pattern.

**Tier 2 — Non-Director with target persona (backfill):**
Matches a target persona but NOT Director+. Ranked:
- 2A: Plant Manager / General Manager
- 2B: Manager (any)
- 2C: All others

Take from Tier 1 → 2A → 2B → 2C until 5 reached.

### Target Personas (strip whitespace before matching)

- `Smart Factory Digitization Projects`
- `CI & Operational Excellence Leader`
- `Plant Leadership`
- `Maintenance Managers & CMMS Champions`
- `Engineering & Automation (SCADA)`
- `Maintenance Operators & Frontline Techs`
- `Maintenance Executives`

**Excluded personas** (don't count as target): CI Leader, Engineering, IT, Facilities, Unknown

### Director+ Title Patterns (case-insensitive regex)

- `\bdirector\b`
- `\bvp\b`, `\bvice\s+president\b`, `\bsvp\b`, `\bevp\b`, `\bavp\b`
- `\bchief\b`, `\bc[a-z]o\b` (3-letter C_O acronyms)
- `\bpresident\b`
- `\bhead\s+of\b`

### Output

Save as: `People List - Matched Leads (New) - ATL.csv` (same directory)

### Verification & Summary

Print:
- Total rows before/after
- Total unique locations (should be same in input and output)
- Every location has ≤5 leads
- Locations trimmed count
- Persona breakdown in output
- Sample of trimmed locations showing tier selections

---

## Implementation Notes

- Use Python 3 with `csv` module (no external dependencies)
- Preserve original column order and all data exactly
- Use `utf-8-sig` encoding when reading (handles BOM)
- Write with `utf-8` encoding
- Steps can be run individually or as a full pipeline
